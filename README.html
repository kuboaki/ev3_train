<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.23">
<title>Building LEGO Train with Mindstorms EV3</title>
<link rel="stylesheet" href="css/mystyle.css">
</head>
<body class="article">
<div id="header">
</div>
<div id="content">
<div class="paragraph">
<p>[English](README.html) | [日本語](README_ja.html)</p>
</div>
<div class="sect1">
<h2 id="_building_lego_train_with_mindstorms_ev3"><a class="anchor" href="#_building_lego_train_with_mindstorms_ev3"></a>Building LEGO Train with Mindstorms EV3</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This repository provides building instructions and programs for train and signal using LEGO Mindstorms EV3 running on the LEGO City Train rails.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
GitHub repository: <a href="https://github.com/kuboaki/ev3_train/" class="bare">https://github.com/kuboaki/ev3_train/</a>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_motivation"><a class="anchor" href="#_motivation"></a>Motivation</h3>
<div class="paragraph">
<p>In train control, until signals using electric lights became popular, people used moving sign boards to indicate departure or stop.</p>
</div>
<div class="paragraph">
<p>For example, at the beginning of the following video, a traffic signal using a sign board is introduced.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The Signal Engineers - 1962 - Electrical Engineering on the Railway</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Click the thumbnail below to play the video.</p>
</div>
<div class="videoblock">
<div class="title">The Signal Engineers - 1962 - Electrical Engineering on the Railway</div>
<div class="content">
<iframe width="480" height="270" src="https://www.youtube.com/embed/jTkf5dL1AwU?rel=0&amp;start=88" frameborder="0" allowfullscreen></iframe>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="http://img.youtube.com/vi/6Oc_50DnGG0/hqdefault.jpg" alt="hqdefault">
</div>
</div>
<div class="paragraph">
<p>It is interesting that if we could test the train control with signal while moving it at hand.
So I decided to try using an old sign board signal, like the shown this video.</p>
</div>
</div>
<div class="sect2">
<h3 id="_system_overview"><a class="anchor" href="#_system_overview"></a>System Overview</h3>
<div class="imageblock">
<div class="content">
<img src="images/train_control_system_w_yellow_signal_w_cables_2.png" alt="train control system w yellow signal w cables 2" width="75%">
</div>
<div class="title">図 1. System Overview</div>
</div>
</div>
<div class="sect2">
<h3 id="_trainsorry_locomotive_only_yet"><a class="anchor" href="#_trainsorry_locomotive_only_yet"></a>Train(Sorry, Locomotive only yet&#8230;&#8203;)</h3>
<div class="paragraph">
<p>This Train is built using LEGO Mindstorms EV3 kits and LEGO City Train parts.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/train_01_w_cables_w_memo.png" alt="train 01 w cables w memo" width="75%">
</div>
<div class="title">図 2. Train(Locomotive)</div>
</div>
<div class="sect3">
<h4 id="_drive_unit"><a class="anchor" href="#_drive_unit"></a>Drive Unit</h4>
<div class="paragraph">
<p>Drive Unit provides a mechanism that runs on wheels by rotating a motor.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>M-Motor(Medium Motor): Drive the wheels.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Motors for City Train are not easy to use with EV3. Also, EV3RT (the development environment used for this project) does not support City Train motors. For these reasons, I 've been using the M motor from the EV3 kit.</p>
</div>
</div>
<div class="sect3">
<h4 id="_singal_reader"><a class="anchor" href="#_singal_reader"></a>Singal Reader</h4>
<div class="paragraph">
<p>This train does not have a driver, so the signal reader reads the signals on behalf of the locomotive driver.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Color Sensor: Reading signal.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_oparation_buttondeparturestop"><a class="anchor" href="#_oparation_buttondeparturestop"></a>Oparation Button(departure/stop).</h4>
<div class="paragraph">
<p>The train accepts operations to move or stop the train with this control button.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Touch Sensor: Accept departure or stop operation.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_block_signal"><a class="anchor" href="#_block_signal"></a>Block signal</h3>
<div class="paragraph">
<p>This Block signal is built using LEGO Mindstorms EV3 kits and LEGO City Train parts.</p>
</div>
<div class="paragraph">
<p>This signal consists of a signal display unit, operation switch and a train detector.</p>
</div>
<div class="paragraph">
<p>This type of signal is called a block signal.
For safety, after the train has passed through the section ahead of this signal, the signal is set to "stop" to prevent other trains from entering the section ahead of the signal until the train is gone.
A traffic control method that allows only one train to run in a section separated by signals in this way is called "blockage control".
The interval between a signal and the next signal is called an occluded interval.</p>
</div>
<div class="sect3">
<h4 id="_signal_display_unit"><a class="anchor" href="#_signal_display_unit"></a>Signal Display Unit</h4>
<div class="paragraph">
<p>Signal display unit provides a mechanism for switching signals by rotating the pallet.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>L-Motor(Large Motor): Rotating signal pallets for displaying signal.</p>
</li>
<li>
<p>Touch Sensor: Detecting signal display motor rotation.</p>
</li>
<li>
<p>Color Sensor: Detecting current signal for present.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Stickers are attached on the bricks for reading the displayed signal. The colors are similar to the blue and yellow of LEGO blocks.
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="images/block_signal_05_w_cables.png" alt="block signal 05 w cables" width="75%">
</div>
<div class="title">図 3. Block Signal(Display Unit, Manual Switch)</div>
</div>
</div>
<div class="sect3">
<h4 id="_manual_switch"><a class="anchor" href="#_manual_switch"></a>Manual Switch</h4>
<div class="paragraph">
<p>Manual switch is used to change singal.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Touch Sensor: Switch signals manually.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_train_detector"><a class="anchor" href="#_train_detector"></a>Train Detector</h4>
<div class="paragraph">
<p>Train detector is used to detect passing trains.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ultrasocnic Sensor: Detecting the passage of a train.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="images/train_detector_02.png" alt="train detector 02" width="75%">
</div>
<div class="title">図 4. Block Signal(Train Detector)</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_building_instructions"><a class="anchor" href="#_building_instructions"></a>Building Instructions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Not ready yet.</p>
</div>
<div class="paragraph">
<p>Please see <code>.io</code> files in <code>images</code> directory.</p>
</div>
<div class="sect2">
<h3 id="_development_environment"><a class="anchor" href="#_development_environment"></a>Development Environment</h3>
<div class="paragraph">
<p>TOPPERS/EV3RT (Real-Time platform for EV3) and C are used for program development.
Older version codes should be modified to be able to run on 1.1.
We recommend updating to 1.1.</p>
</div>
<div class="paragraph">
<p>Of course, any other programming language that supports the EV3 will work just fine.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">EV3RT on TOPPERS</dt>
<dd>
<p><a href="https://dev.toppers.jp/trac_user/ev3pf/wiki/WhatsEV3RT" class="bare">https://dev.toppers.jp/trac_user/ev3pf/wiki/WhatsEV3RT</a></p>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
If you want to simulate using the hakoniwa-ros2sim environment, please refer to [How to simulate](hakoniwa-ros2sim_simulation.md) (sorry, only for Japanese).
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_contents_tree"><a class="anchor" href="#_contents_tree"></a>Contents Tree</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-console" data-lang="console">├── images: LEGO Studio, Blender, png
├── models: system design model(uml)
├── block_signal: coes for block signal
├── train_slow_stop: codes for train slow down stop
└── train: codes for train</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_build_program"><a class="anchor" href="#_build_program"></a>Build Program</h3>
<div class="sect3">
<h4 id="_clone_this_ripository_in_your_ev3rt_workspace"><a class="anchor" href="#_clone_this_ripository_in_your_ev3rt_workspace"></a>Clone this ripository in your EV3RT workspace</h4>
<div class="paragraph">
<p>EV3RT has a default <code>workspace</code> for building programs.
Clone the <code>ev3_train</code> repository in the same hierarchy as workspace.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">$ cd {install_dir}/ev3rt-1.1-release/hrp3/sdk
$ git clone https://github.com/kuboaki/ev3_train.git</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_build_trains_program"><a class="anchor" href="#_build_trains_program"></a>Build train&#8217;s program</h4>
<div class="paragraph">
<p>Move to <code>ev3_train</code> directory. And then build train program.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">$ cd ev3_train
$ pwd
{install_dir}/ev3rt-1.1-release/hrp3/sdk/ev3_train
$ make app=train
$ ls -l app
-rw-r--r--  1 kuboaki  staff  102204  8  9 17:48 app</code></pre>
</div>
</div>
<div class="paragraph">
<p>Transfer this <code>app</code> file to the train&#8217;s EV3.
For transfer instructions, see the EV3RT website.</p>
</div>
</div>
<div class="sect3">
<h4 id="_build_signals_program"><a class="anchor" href="#_build_signals_program"></a>Build signal&#8217;s program</h4>
<div class="paragraph">
<p>Also in the <code>ev3_train</code> directory, build the signal&#8217;s program.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">$ pwd
{install_dir}/ev3rt-1.1-release/hrp3/sdk/ev3_train
$ make app=block_signal
$ ls -l app
-rw-r--r--  1 kuboaki  staff  104932  8  9 17:49 app</code></pre>
</div>
</div>
<div class="paragraph">
<p>Transfer this <code>app</code> file to the signal&#8217;s EV3.
For transfer instructions, see the EV3RT website.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_operate_the_entire_system"><a class="anchor" href="#_operate_the_entire_system"></a>Operate the entire system</h3>
<div class="imageblock">
<div class="content">
<img src="images/train_control_system_w_yellow_signal_w_memo.png" alt="train control system w yellow signal w memo" width="100%">
</div>
<div class="title">図 5. Oparations of EV3 Train System</div>
</div>
<div class="sect3">
<h4 id="_run_the_train_t1_t2"><a class="anchor" href="#_run_the_train_t1_t2"></a>Run the train( t1, t2, &#8230;&#8203; )</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Launch the transferred program. (See the EV3RT website for how to start.)</p>
</li>
<li>
<p>When activated, a warning horn sounds and the vehicle waits for an instruction to start running.</p>
</li>
<li>
<p>Place the train on the tracks and put the wheels on the rails.</p>
</li>
<li>
<p>When you press the operation button, a confirmation horn sounds and the vehicle starts running.</p>
</li>
<li>
<p>When the signal reader unit (using color sensor mounted upward) reads the stop signal (red), an arrival horn sounds and the train stops.</p>
</li>
<li>
<p>When the signal reader unit reads the departure signal (green), a confirmation horn sounds and the train resumes running.</p>
</li>
<li>
<p>When the operation button is pressed, the train stops in the operation end state.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_oparate_the_singal_s1_s2"><a class="anchor" href="#_oparate_the_singal_s1_s2"></a>Oparate the singal( s1, s2, &#8230;&#8203; )</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Launch the transferred program.</p>
</li>
<li>
<p>When activated, a confirmation horn sounds, the motor rotates, and the preparatory operation begins.</p>
</li>
<li>
<p>When the stop signal appears (red saide down), the motor will stop.</p>
</li>
<li>
<p>When the train comes under the signal, it reads the stop signal and stops.</p>
</li>
<li>
<p>When you press the manual switch, the motor rotates and the signal shows the departure signal (green side down).</p>
</li>
<li>
<p>When the train detector (using ultrasonic sensor) recognizes a running train, the signal changes to a stop signal.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The video below shows the behavior of trains and signal.
Click the thumbnail below to play the video.</p>
</div>
<div class="videoblock">
<div class="title">The Signal Engineers - 1962 - Electrical Engineering on the Railway</div>
<div class="content">
<iframe width="480" height="270" src="https://www.youtube.com/embed/k168I_5-GNs?rel=0" frameborder="0" allowfullscreen></iframe>
</div>
</div>
<div class="paragraph">
<p>State Machine of Train class (see more detail in [models](./models) directory).</p>
</div>
<div class="paragraph">
<p>![Train classs run method state machine diagram](models/Train_class_run_method_stm.png)</p>
</div>
<div class="paragraph">
<p>State Machine of BlockSignal class (see more detail in [models](./models) directory).</p>
</div>
<div class="paragraph">
<p>![BlockSignal classs run method state machine diagram](models/BlockSignal_classs_run_method_stm_2.png)</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_train_slowing_down_before_the_signal"><a class="anchor" href="#_train_slowing_down_before_the_signal"></a>Train slowing down before the signal</h3>
<div class="paragraph">
<p>Move to <code>ev3_train</code> directory. And then build <code>train_slow_stop</code>  program.
This train slows down when it recognizes the warning sign near the signal.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">$ cd ev3_train
$ pwd
{install_dir}/ev3rt-1.1-release/hrp3/sdk/ev3_train
$ make app=train_slow_stop
$ ls -l app
-rw-r--r--  1 kuboaki  staff  102552  8  9 18:35 app</code></pre>
</div>
</div>
<div class="paragraph">
<p>Transfer this <code>app</code> file to the train&#8217;s EV3.</p>
</div>
<div class="paragraph">
<p>You can save the first one as well if you give it a different name (e.g. "app_slow") when transferring.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s run it after transferring.</p>
</div>
<div class="paragraph">
<p>The video below shows the train slowing down before the signal.
Click the thumbnail below to play the video.</p>
</div>
<div class="paragraph">
<p>[![EV3 Train slow down](<a href="https://img.youtube.com/vi/71gXzo7RDiw/hq2.jpg" class="bare">https://img.youtube.com/vi/71gXzo7RDiw/hq2.jpg</a>)](<a href="https://youtu.be/71gXzo7RDiw" class="bare">https://youtu.be/71gXzo7RDiw</a>)</p>
</div>
<div class="paragraph">
<p>Added "slowing_down" state on the train state machine diagram.</p>
</div>
<div class="paragraph">
<p>State Machine of Train class (see more detail in [models](./models) directory).</p>
</div>
<div class="paragraph">
<p>![Train SLow Stopclasss run method state machine diagram](models/Train_Slow_Stop_class_run_method_stm.png)</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2025-04-15 11:55:06 +0900
</div>
</div>
</body>
</html>